<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Naveen Kannan">
<meta name="dcterms.date" content="2025-05-14">
<meta name="description" content="A guide to configuring pgBackRest to securely perform SFTP based backups of your PostgreSQL server.">

<title>Secure SFTP Backups with pgBackRest for PostgreSQL: A Step-by-Step Guide</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
<meta property="og:title" content="Secure SFTP Backups with pgBackRest for PostgreSQL: A Step-by-Step Guide">
<meta property="og:description" content="A guide to configuring pgBackRest to securely perform SFTP based backups of your PostgreSQL server.">
<meta property="og:image" content="pgbackrest_logo.png">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Naveen Kannan</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../publications.html" rel="" target="">
 <span class="menu-text">Publications</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../portfolio.html" rel="" target="">
 <span class="menu-text">Portfolio</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog_main.html" rel="" target="">
 <span class="menu-text">Blog Posts</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/naveenk2022" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/naveenkannan1/" rel="" target=""><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/naveenk2022/data_resume/blob/main/resume.pdf" rel="" target=""><i class="bi bi-file-person" role="img">
</i> 
 <span class="menu-text">CV</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#database-server-requirements" id="toc-database-server-requirements" class="nav-link" data-scroll-target="#database-server-requirements">Database Server Requirements</a></li>
  <li><a href="#sftp-host-requirements" id="toc-sftp-host-requirements" class="nav-link" data-scroll-target="#sftp-host-requirements">SFTP Host Requirements</a></li>
  <li><a href="#network-requirements" id="toc-network-requirements" class="nav-link" data-scroll-target="#network-requirements">Network Requirements</a></li>
  </ul></li>
  <li><a href="#the-process" id="toc-the-process" class="nav-link" data-scroll-target="#the-process">The Process</a>
  <ul class="collapse">
  <li><a href="#on-the-database-host" id="toc-on-the-database-host" class="nav-link" data-scroll-target="#on-the-database-host">On the database host</a></li>
  <li><a href="#on-the-sftp-server-host" id="toc-on-the-sftp-server-host" class="nav-link" data-scroll-target="#on-the-sftp-server-host">On the SFTP server host</a>
  <ul class="collapse">
  <li><a href="#create-a-directory-that-the-sftp-user-account-will-be-restricted-to." id="toc-create-a-directory-that-the-sftp-user-account-will-be-restricted-to." class="nav-link" data-scroll-target="#create-a-directory-that-the-sftp-user-account-will-be-restricted-to."><em>Create a directory that the SFTP user account will be restricted to.</em></a></li>
  <li><a href="#create-an-sftp-group-followed-by-an-sftp-user-with-minimal-permissions-and-as-a-system-user." id="toc-create-an-sftp-group-followed-by-an-sftp-user-with-minimal-permissions-and-as-a-system-user." class="nav-link" data-scroll-target="#create-an-sftp-group-followed-by-an-sftp-user-with-minimal-permissions-and-as-a-system-user."><em>Create an SFTP group, followed by an SFTP user with minimal permissions and as a system user.</em></a></li>
  <li><a href="#change-the-permissions-for-the-sftp-directory." id="toc-change-the-permissions-for-the-sftp-directory." class="nav-link" data-scroll-target="#change-the-permissions-for-the-sftp-directory."><em>Change the permissions for the SFTP directory.</em></a></li>
  <li><a href="#updating-the-ssh-configuration-on-the-sftp-server." id="toc-updating-the-ssh-configuration-on-the-sftp-server." class="nav-link" data-scroll-target="#updating-the-ssh-configuration-on-the-sftp-server."><em>Updating the SSH configuration on the SFTP server.</em></a></li>
  <li><a href="#validate-your-ssh-config-and-then-restart-the-ssh-daemon" id="toc-validate-your-ssh-config-and-then-restart-the-ssh-daemon" class="nav-link" data-scroll-target="#validate-your-ssh-config-and-then-restart-the-ssh-daemon"><em>Validate your SSH config and then Restart the SSH daemon</em></a></li>
  <li><a href="#create-the-ssh-directory-for-the-sftpuser-account-with-appropriate-permissions" id="toc-create-the-ssh-directory-for-the-sftpuser-account-with-appropriate-permissions" class="nav-link" data-scroll-target="#create-the-ssh-directory-for-the-sftpuser-account-with-appropriate-permissions"><em>Create the SSH directory for the sftpuser account with appropriate permissions</em></a></li>
  <li><a href="#append-the-contents-of-the-new-public-ssh-key-to-the-authorized_keys-file" id="toc-append-the-contents-of-the-new-public-ssh-key-to-the-authorized_keys-file" class="nav-link" data-scroll-target="#append-the-contents-of-the-new-public-ssh-key-to-the-authorized_keys-file"><em>Append the contents of the new public SSH key to the authorized_keys file</em></a></li>
  </ul></li>
  </ul></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing">Testing</a></li>
  <li><a href="#deploying" id="toc-deploying" class="nav-link" data-scroll-target="#deploying">Deploying</a></li>
  <li><a href="#addendum" id="toc-addendum" class="nav-link" data-scroll-target="#addendum">Addendum</a>
  <ul class="collapse">
  <li><a href="#using-secure-key-algorithms-and-hash-functions" id="toc-using-secure-key-algorithms-and-hash-functions" class="nav-link" data-scroll-target="#using-secure-key-algorithms-and-hash-functions">Using secure key algorithms and hash functions</a>
  <ul class="collapse">
  <li><a href="#check-the-key-algorithms-supported-by-your-installation-of-libssh2" id="toc-check-the-key-algorithms-supported-by-your-installation-of-libssh2" class="nav-link" data-scroll-target="#check-the-key-algorithms-supported-by-your-installation-of-libssh2">Check the key algorithms supported by your installation of libssh2</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Secure SFTP Backups with pgBackRest for PostgreSQL: A Step-by-Step Guide</h1>
  <div class="quarto-categories">
    <div class="quarto-category">PostgreSQL</div>
    <div class="quarto-category">pgBackRest</div>
    <div class="quarto-category">Database Backups</div>
    <div class="quarto-category">Linux Administration</div>
    <div class="quarto-category">DevOps</div>
    <div class="quarto-category">Security</div>
  </div>
  </div>

<div>
  <div class="description">
    A guide to configuring pgBackRest to securely perform SFTP based backups of your PostgreSQL server.
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Naveen Kannan </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">May 14, 2025</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>pgBackRest is an open source tool that allows you to perform automated backup and restore operations for a PostgreSQL server. It allows you to take both full and incremental file system backups of your data. With pgBackRest, you can set up multiple repositories for your backups, both local and remote. You can further customize the configuration to take backups at specific times of the day so that regular operations are not affected, and backup retention and rotation can be customized as needed.</p>
<p>Furthermore, it allows mirroring of backups to cloud-compatible object stores, including S3, Azure, and GCS compatible object stores.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="pgbackrest_logo.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">pgBackRest helps make taking database backups pretty straightforward.</figcaption>
</figure>
</div>
<p>nsecurely configured SFTP backups can expose critical database content to unauthorized access, yet many organizations rely on them for off-site storage. This guide addresses the security gap and will explain the process of setting up remote SFTP repositories in a secure manner. We will create a system user on the SFTP repository and limit their permissions, and perform scheduled backups exclusively via the limited user account.</p>
<p>A good database backup strategy uses multiple repositories of different types, alongside both physical and logical backups. Do not limit yourself to merely SFTP repositories. Remember, with database backups, redundancy is good. This tutorial is simply to explain how to <em>securely</em> configure SFTP backups.</p>
<section id="database-server-requirements" class="level2">
<h2 class="anchored" data-anchor-id="database-server-requirements">Database Server Requirements</h2>
<ul>
<li><p>PostgreSQL 12.0 or newer (this tutorial uses PostgreSQL 17.0)</p>
<ul>
<li>PostgreSQL 12.0+ is required because earlier versions lack WAL archiving features that enable point-in-time recovery when using pgBackRest.</li>
</ul></li>
<li><p>pgBackRest 2.41 or newer (this tutorial uses pgBackRest 2.55.1)</p>
<ul>
<li>Earlier versions may have limitations with certain authentication methods</li>
</ul></li>
<li><p>OpenSSH 8.0+ client for improved Ed25519 key support</p></li>
<li><p>libssh2 1.9.0+ for modern cryptographic algorithm support</p></li>
<li><p>Sufficient disk space for temporary backup files before transfer</p></li>
</ul>
</section>
<section id="sftp-host-requirements" class="level2">
<h2 class="anchored" data-anchor-id="sftp-host-requirements">SFTP Host Requirements</h2>
<ul>
<li><p>Linux server with SSH daemon supporting SFTP subsystem</p>
<ul>
<li>Recommended: OpenSSH 8.0+ for optimal security features</li>
</ul></li>
<li><p>Sufficient storage space for your backup retention needs. Plan for minimum 3x your database size (1x for full backup + 1x for transaction logs + 1x overhead and retention)</p></li>
<li><p>Root access for initial configuration</p></li>
<li><p>Ability to create dedicated system users and groups</p></li>
<li><p>Firewall configured to allow SFTP connections (typically port 22) from your database server IP</p></li>
</ul>
</section>
<section id="network-requirements" class="level2">
<h2 class="anchored" data-anchor-id="network-requirements">Network Requirements</h2>
<ul>
<li><p>Stable network connection between database and SFTP servers</p></li>
<li><p>Firewall rules allowing SFTP traffic (TCP port 22 by default)</p></li>
<li><p>Recommended: Internal network connectivity (avoid public internet exposure if possible)</p></li>
</ul>
<p>You can check your versions with these commands:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">postgres</span> <span class="at">--version</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pgbackrest</span> version</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> <span class="at">-V</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="the-process" class="level1">
<h1>The Process</h1>
<p>For this process, this guide assumes both servers are on a private network (10.0.0.0/24) protected by a corporate firewall, with the following IP addresses:</p>
<ul>
<li><p>The IP of the database server is <code>10.0.0.1</code></p></li>
<li><p>The user that runs the code on the database server is <code>postgres</code>. <code>postgres</code> is a system user and cannot log in via SSH.</p></li>
<li><p>The IP of the SFTP repo is <code>10.0.0.2</code></p></li>
</ul>
<section id="on-the-database-host" class="level2">
<h2 class="anchored" data-anchor-id="on-the-database-host">On the database host</h2>
<ul>
<li>Create an SSH key pair in the <code>postgres</code> user’s home directory.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust this path based on your system's postgres home</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PGHOME</span><span class="op">=</span>/var/lib/postgresql</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-f</span> <span class="va">$PGHOME</span>/.ssh/id_ed25519_sftp_key <span class="at">-t</span> ed25519 <span class="at">-N</span> <span class="st">""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Ensure that the <code>.ssh</code> folder is owned by the <code>postgres</code> user. We use Ed25519 keys because they provide stronger security with shorter keys compared to RSA, and are supported by modern OpenSSH implementations.</p>
<ul>
<li>Perform a key scan on the SFTP host to gather the public keys. Make sure you verify the legitimacy of the host server before you build your known hosts file.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keyscan</span> 10.0.0.2 <span class="op">&gt;&gt;</span> <span class="va">$PGHOME</span>/.ssh/known_hosts </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You can validate the host keys via fingerprints by running:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh-keygen</span> <span class="at">-lf</span> <span class="va">$PGHOME</span>/.ssh/known_hosts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="on-the-sftp-server-host" class="level2">
<h2 class="anchored" data-anchor-id="on-the-sftp-server-host">On the SFTP server host</h2>
<section id="create-a-directory-that-the-sftp-user-account-will-be-restricted-to." class="level3">
<h3 class="anchored" data-anchor-id="create-a-directory-that-the-sftp-user-account-will-be-restricted-to."><em>Create a directory that the SFTP user account will be restricted to.</em></h3>
<p>We create a dedicated /data directory separate from standard system paths to isolate backup data and simplify permission management.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating a folder in the root directory</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /data</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the home directory for the SFTP user</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> /data/sftpuser/upload</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Setting the appropriate permissions for this filesystem</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 701 /data</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">## /data needs to have root:root permissions</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="fu">chown</span> root:root /data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="create-an-sftp-group-followed-by-an-sftp-user-with-minimal-permissions-and-as-a-system-user." class="level3">
<h3 class="anchored" data-anchor-id="create-an-sftp-group-followed-by-an-sftp-user-with-minimal-permissions-and-as-a-system-user."><em>Create an SFTP group, followed by an SFTP user with minimal permissions and as a system user.</em></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating an SFTP group</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">groupadd</span> sftpusers</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the SFTP user as a system user</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">useradd</span> <span class="at">-g</span> sftpusers <span class="at">-d</span> /data/sftpuser/upload/ <span class="at">-s</span> /usr/sbin/nologin <span class="at">-r</span> sftpuser</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This process creates a group called <code>sftpusers</code> and creates a system user in that group called <code>sftpuser</code>, with their home directory being <code>/data/sftpuser/upload</code>.</p>
</section>
<section id="change-the-permissions-for-the-sftp-directory." class="level3">
<h3 class="anchored" data-anchor-id="change-the-permissions-for-the-sftp-directory."><em>Change the permissions for the SFTP directory.</em></h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">## Giving ownership to the sftpusers group for the sftpuser folder</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">chown</span> root:sftpusers /data/sftpuser</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Giving the sftpuser system account access to the home directory we created</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">chown</span> sftpuser:sftpusers /data/sftpuser/upload</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It is very important that <code>/data/sftpuser/upload</code> must <em>not</em> be owned by root. This is a common cause of failure for chroot setups.</p>
</section>
<section id="updating-the-ssh-configuration-on-the-sftp-server." class="level3">
<h3 class="anchored" data-anchor-id="updating-the-ssh-configuration-on-the-sftp-server."><em>Updating the SSH configuration on the SFTP server.</em></h3>
<p>Add the following to the end <code>/etc/ssh/sshd_config</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For sftp backups</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Match</span> Group sftpusers</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ChrootDirectory</span> /data/%u</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ForceCommand</span> internal-sftp</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">AllowTcpForwarding</span> no</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">X11Forwarding</span> no</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s what this does:</p>
<ul>
<li><p>The first line <code>Match Group sftpusers</code> starts a conditional block that only applies to users in the <code>sftpusers</code> group.</p></li>
<li><p>The second line <code>ChrootDirectory /data/%u</code> (jails) the user to the directory <code>/data/username</code>, where <code>%u</code> is replaced with the <code>username</code>. This ensures the user is jailed to their upload directory and cannot access the broader file system.</p></li>
<li><p>The third line <code>ForceCommand internal-sftp</code> forces the SSH session to use the internal SFTP subsystem. The user cannot get a shell session, and only SFTP is allowed.</p></li>
<li><p>The fourth line <code>AllowTcpForwarding no</code> prevents the user using SSH port forwarding to avoid tunneling through SSH.</p></li>
<li><p>The fifth line <code>X11Forwarding no</code> disables X11 forwarding to prevent GUI application tunneling over SSH.</p></li>
</ul>
</section>
<section id="validate-your-ssh-config-and-then-restart-the-ssh-daemon" class="level3">
<h3 class="anchored" data-anchor-id="validate-your-ssh-config-and-then-restart-the-ssh-daemon"><em>Validate your SSH config and then Restart the SSH daemon</em></h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> sshd <span class="at">-T</span> <span class="kw">&amp;&amp;</span> <span class="fu">sudo</span> systemctl restart sshd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Do not restart the SSH daemon without validating your SSH config with <code>sudo sshd -T</code>! If your config is wrong, the daemon will fail to initiate, and you may be locked out of being able to SSH into the server!</p>
</div>
</div>
</section>
<section id="create-the-ssh-directory-for-the-sftpuser-account-with-appropriate-permissions" class="level3">
<h3 class="anchored" data-anchor-id="create-the-ssh-directory-for-the-sftpuser-account-with-appropriate-permissions"><em>Create the SSH directory for the sftpuser account with appropriate permissions</em></h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Creating the .ssh directory</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /data/sftpuser/upload/.ssh</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">## Creating the authorized_keys and known_hosts files</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /data/sftpuser/upload/.ssh/authorized_keys</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> /data/sftpuser/upload/.ssh/known_hosts</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Changing permissions for the newly created folders and files</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="fu">chown</span> <span class="at">-R</span> sftpuser:sftpusers /data/sftpuser/upload/.ssh</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 700 /data/sftpuser/upload/.ssh</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 640 /data/sftpuser/upload/.ssh/authorized_keys</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> 644 /data/sftpuser/upload/.ssh/known_hosts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="append-the-contents-of-the-new-public-ssh-key-to-the-authorized_keys-file" class="level3">
<h3 class="anchored" data-anchor-id="append-the-contents-of-the-new-public-ssh-key-to-the-authorized_keys-file"><em>Append the contents of the new public SSH key to the authorized_keys file</em></h3>
<p>On the database host, copy the contents of the public key we created (<code>$PGHOME/.ssh/id_ed25519_sftp_key.pub</code>) and append it to the authorized_keys file on the SFTP user’s SSH directory (‘/data/sftpuser/upload/.ssh/authorized_keys’).</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remember to <em>never share your private key</em> with any server, or to anyone else! Only copy the contents of the public key!</p>
</div>
</div>
</section>
</section>
</section>
<section id="testing" class="level1">
<h1>Testing</h1>
<p>From the database host, test if you can login to the SFTP server using the keys without needing a password.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">sftp</span> <span class="at">-i</span> <span class="va">$PGHOME</span>/.ssh/id_ed25519_sftp_key sftpuser@10.0.0.2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If your setup was correct, this will let you login without a password.</p>
</section>
<section id="deploying" class="level1">
<h1>Deploying</h1>
<p>Update your <code>pgbackrest.config</code> file with the following:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># SFTP Backup Repo</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-bundle</span><span class="ot">=</span><span class="st">y</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-path</span><span class="ot">=</span><span class="st">/upload</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Host</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-host</span><span class="ot">=</span><span class="st">10.0.0.2</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-host-key-hash-type</span><span class="ot">=</span><span class="st">sha256</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># User</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-host-user</span><span class="ot">=</span><span class="st">sftpuser</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Key Location</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-private-key-file</span><span class="ot">=</span><span class="st">/var/lib/postgresql/.ssh/id_ed25519_sftp_key</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-public-key-file</span><span class="ot">=</span><span class="st">/var/lib/postgresql/.ssh/id_ed25519_sftp_key.pub</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-type</span><span class="ot">=</span><span class="st">sftp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The above configuration file sets up the automation process for transferring backups to the SFTP host via the SFTP service, as the user <code>sftpuser</code>, who has restricted permissions.</p>
<p>An example of a full <code>pgbackrest.conf</code> file: (The default location is <code>/etc/pgbackrest/pgbackrest.conf</code>)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode ini code-with-copy"><code class="sourceCode ini"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[main]</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">pg1-path</span><span class="ot">=</span><span class="st">/usr/local/pgsql/data</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="dt">pg1-port</span><span class="ot">=</span><span class="dv">5432</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="dt">pg1-user</span><span class="ot">=</span><span class="st">postgres</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="dt">pg1-database</span><span class="ot">=</span><span class="st">postgres</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">[global]</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Local Backup Repo</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="dt">repo1-cipher-pass</span><span class="ot">=</span><span class="st">xxx # Insert with your own</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="dt">repo1-cipher-type</span><span class="ot">=</span><span class="st">aes-256-cbc</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="dt">repo1-path</span><span class="ot">=</span><span class="st">/var/lib/pgbackrest</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="dt">repo1-retention-full</span><span class="ot">=</span><span class="dv">2</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co"># SFTP Backup Repo 1</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co"># This section handles the configuration for your SFTP repo</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-bundle</span><span class="ot">=</span><span class="st">y</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-path</span><span class="ot">=</span><span class="st">/upload</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-retention-full</span><span class="ot">=</span><span class="dv">2</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Host</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-host</span><span class="ot">=</span><span class="st">10.0.0.2</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-host-key-hash-type</span><span class="ot">=</span><span class="st">sha256</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co"># User</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-host-user</span><span class="ot">=</span><span class="st">sftpuser</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Key Location</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-private-key-file</span><span class="ot">=</span><span class="st">/var/lib/postgresql/.ssh/id_ed25519_sftp_key</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="dt">repo2-sftp-public-key-file</span><span class="ot">=</span><span class="st">/var/lib/postgresql/.ssh/id_ed25519_sftp_key.pub</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Logging Info</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="dt">log-path</span><span class="ot">=</span><span class="st">/var/log/pgbackrest</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="dt">log-level-console</span><span class="ot">=</span><span class="st">debug</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="kw">[global:archive-push]</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="dt">compress-level</span><span class="ot">=</span><span class="dv">3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Then create the stanza by running the following as the <code>postgres</code> user:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pgbackrest</span> <span class="at">--stanza</span><span class="op">=</span>main <span class="at">--log-level-console</span><span class="op">=</span>info stanza-create</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If your config is right, then this will succeed with the following output:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">P00</span>   INFO: stanza-create command end: completed successfully</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="addendum" class="level1">
<h1>Addendum</h1>
<section id="using-secure-key-algorithms-and-hash-functions" class="level2">
<h2 class="anchored" data-anchor-id="using-secure-key-algorithms-and-hash-functions">Using secure key algorithms and hash functions</h2>
<p>If you are using older versions of cryptography libraries like libssh2 and openssl, your configuration might be restricted to using older, more outdated key algorithms like RSA or DSS, along with older hash functions like SHA1. I recommend using more secure, newer key algorithms like Ed25519, along with more secure hashing functions like SHA256.</p>
<section id="check-the-key-algorithms-supported-by-your-installation-of-libssh2" class="level3">
<h3 class="anchored" data-anchor-id="check-the-key-algorithms-supported-by-your-installation-of-libssh2">Check the key algorithms supported by your installation of libssh2</h3>
<p>Run the following code to see what key types are supported by your installation of libssh2:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> /usr/lib/x86_64-linux-gnu/libssh2.so.1 <span class="kw">|</span> <span class="fu">grep</span> ssh-</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Your output should return more modern key algorithms like <code>ssh-ed25519</code>. If you output only includes algorithms like <code>ssh-rsa</code> or <code>ssh-dss</code>, then you will need to update your installation of libssh2. Some older servers, like ones running outdated operating systems like Ubuntu 20.04, may not allow you to update your libssh2 library using package managers. In that case, you will have to manually build the newer versions from source.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Installing dependencies</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install build-essential cmake zlib1g-dev libssl-dev</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Downloading and building libssh2 from source</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://www.libssh2.org/download/libssh2-1.11.0.tar.gz</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tar</span> <span class="at">-xzf</span> libssh2-1.11.0.tar.gz</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> libssh2-1.11.0</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Installing libssh2</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j</span><span class="va">$(</span><span class="fu">nproc</span><span class="va">)</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> make install</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ldconfig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The new libssh2 library will have it’s binaries located at <code>/usr/local/lib/libssh2.so</code>. You can confirm if it was installed by running:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">strings</span> /usr/local/lib/libssh2.so <span class="kw">|</span> <span class="fu">grep</span> ssh-</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>You should see the newer key algorithms like <code>ecdsa-sha2-nistp256</code>and <code>ssh-ed25519</code>.</p>
<p>If you built/installed pgBackRest <em>before</em> updating your libssh2 library, you will need to rebuild it from source so that it uses the newer library.</p>
<p>To check if pgBackRest is using the newly installed libssh2 as a dependency, run:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ldd</span> <span class="va">$(</span><span class="fu">which</span> pgbackrest<span class="va">)</span> <span class="kw">|</span> <span class="fu">grep</span> libssh2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Your output should look like this:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">libssh2.so.1</span> =<span class="op">&gt;</span> /usr/local/lib/libssh2.so.1 <span class="er">(</span><span class="ex">0x00007f20882cf000</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This confirms that pgBackRest is using the manually installed libssh2 from <code>/usr/local/lib</code>, rather than the system-wide default at <code>/usr/lib/x86_64-linux-gnu</code>.</p>
</section>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<ul>
<li><p><a href="https://pgbackrest.org/user-guide.html">pgBackRest documentation</a></p></li>
<li><p><a href="https://libssh2.org/">libssh2</a></p></li>
<li><p>[PostgreSQL backup documentation] (https://www.postgresql.org/docs/current/backup.html)</p></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="naveenk2022/website-giscus-comments" data-repo-id="R_kgDOKri3cw" data-category="Announcements" data-category-id="DIC_kwDOKri3c84Ca1Xu" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>